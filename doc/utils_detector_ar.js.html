<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/detector_ar.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/detector_ar.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* @file DetectorAR
* @author Fernando Segura Gómez, Twitter: @fsgdev
* @version 0.1
*/

/**
* Clase DetectorAR
* @class
* @constructor
* @param {Canvas} WIDTH - Recibe el elemento canvas el cual se obtendra la información para detectar el marcador
*/
function DetectorAR(canvas_element){
  var JSARRaster,JSARParameters,detector,result;
  var markers_attach={};
  var threshold=120;
  var markers={};
  var DetectorMarker;
  var rootMarker,markermatrix;


  /**
  * @function init
  * @summary Inicializa las dependencias y variables necesarias.
  */
  function init(){
    JSARRaster = new NyARRgbRaster_Canvas2D(canvas_element);
    DetectorMarker=require("./detectormarker.js");
    JSARParameters = new FLARParam(canvas_element.width, canvas_element.height);
    detector = new FLARMultiIdMarkerDetector(JSARParameters, 40);
    result = new Float32Array(16);
    detector.setContinueMode(true);
    JSARParameters.copyCameraMatrix(result, .1, 2000);
    THREE.Matrix4.prototype.setFromArray = function(m) {
      return this.set(
        m[0], m[4], m[8], m[12],
        m[1], m[5], m[9], m[13],
        m[2], m[6], m[10], m[14],
        m[3], m[7], m[11], m[15]
      );
    }

    THREE.Object3D.prototype.transformFromArray = function(m) {
      this.matrix.setFromArray(m);
      this.matrixWorldNeedsUpdate = true;
    }
  }


  /**
  * @function setCameraMatrix
  * @summary Inicializa las dependencias y variables necesarias.
  * @param {THREE.Camera} realidadCamera - Recibe la cámara que observa los objetos que usaara JSArtoolkit como punteros.
  */
  var setCameraMatrix=function(realidadCamera){
    realidadCamera.projectionMatrix.setFromArray(result);
  }

  /**
  * @function getMarkerNumber
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  function getMarkerNumber(idx) {
    var data = detector.getIdMarkerData(idx);
    if (data.packetLength > 4) {
      return -1;
    }

    var result=0;
    for (var i = 0; i &lt; data.packetLength; i++ ) {
      result = (result &lt;&lt; 8) | data.getPacketData(i);
    }

    return result;
  }


  /**
  * @function getTransformMatrix
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  function getTransformMatrix(idx) {
    var mat = new NyARTransMatResult();
    detector.getTransformMatrix(idx, mat);

    var cm = new Float32Array(16);
    cm[0] = mat.m00*-1;
    cm[1] = -mat.m10;
    cm[2] = mat.m20;
    cm[3] = 0;
    cm[4] = mat.m01*-1;
    cm[5] = -mat.m11;
    cm[6] = mat.m21;
    cm[7] = 0;
    cm[8] = -mat.m02;
    cm[9] = mat.m12;
    cm[10] = -mat.m22;
    cm[11] = 0;
    cm[12] = mat.m03*-1;
    cm[13] = -mat.m13;
    cm[14] = mat.m23;
    cm[15] = 1;

    return cm;
  }


  /**
  * @function obtenerMarcador
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  function obtenerMarcador(markerCount,pos){
    var matriz_encontrada
    for(var i=0;i&lt;markerCount;i++){
      if(i==pos){
        matriz_encontrada=getTransformMatrix(i);
        break;
      }
    }
    return matriz_encontrada;
  }


  /**
  * @function isAttached
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  function isAttached(id){
    return markers_attach[id]!=undefined;
  }


  /**
  * @function detectMarker
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  var detectMarker=function(stage){
    var markerCount = detector.detectMarkerLite(JSARRaster, threshold);
    var marker;
    if(markerCount>0){
      for(var i=0,marcador_id=-1;i&lt;markerCount;i++){
        var marcador_id=getMarkerNumber(i);
        if(markers[marcador_id]!=undefined){
          if(markers[marcador_id].puntero!=undefined){
            markers[marcador_id].puntero.transformFromArray(obtenerMarcador(markerCount,i));
            markers[marcador_id].puntero.matrixWorldNeedsUpdate=true;
          }
          if(!isAttached(marcador_id))
          markers[marcador_id].detected().call(stage,markers[marcador_id].puntero);
          else
          markers_attach[marcador_id]=1;
        }
      }
      if(Object.keys(markers_attach).length>0){
        var count=0;
        for(var id in markers_attach){
          count+=markers_attach[id];
          markers_attach[id]=0;
        }
        if(count==Object.keys(markers_attach).length)//If all the markers attached are not detected, then the event is not executed
        rootMarker.detected().call(stage,rootMarker.puntero);
      }
      return true;
    }
    return false;
  }


  /**
  * @function attach
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  var attach=function(markers_to_attach){
    var marker_list=Object.keys(markers);
    if(marker_list.length>0)
    rootMarker=markers[marker_list.pop()];
    markers_attach[rootMarker.id]=0;
    for(var i=0,length=markers_to_attach.length;i&lt;length;i++){
      this.addMarker(markers_to_attach[i]);
      markers_attach[markers_to_attach[i].id]=0;
    }
  }


  /**
  * @function addMarker
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  var addMarker=function(marker){
    markers[marker.id]=new DetectorMarker(marker.id,marker.callback,marker.puntero);
    return this;
  }


  /**
  * @function cleanMarkers
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  var cleanMarkers=function(){
    markers={};
  }


  /**
  * @function cambiarThreshold
  * @summary Obtiene el número de marcador
  * @param {Integer} idx - Recibe el id del marcador.
  */
  var cambiarThreshold=function(threshold_nuevo){
    threshold=threshold_nuevo;
  }

  return{
    init:init,
    attach:attach,
    setCameraMatrix,setCameraMatrix,
    detectMarker:detectMarker,
    addMarker:addMarker,
    markermatrix:markermatrix,
    cambiarThreshold:cambiarThreshold,
    cleanMarkers:cleanMarkers
  }
}

module.exports=DetectorAR;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DetectorAR.html">DetectorAR</a></li><li><a href="Elemento.html">Elemento</a></li><li><a href="Escenario.html">Escenario</a></li><li><a href="Mediador.html">Mediador</a></li><li><a href="Memorama.html">Memorama</a></li></ul><h3>Global</h3><ul><li><a href="global.html#actualizarMaterialAtras">actualizarMaterialAtras</a></li><li><a href="global.html#actualizarMaterialFrente">actualizarMaterialFrente</a></li><li><a href="global.html#actualizarMedidas">actualizarMedidas</a></li><li><a href="global.html#addMarker">addMarker</a></li><li><a href="global.html#allowDetect">allowDetect</a></li><li><a href="global.html#anadir">anadir</a></li><li><a href="global.html#anadirMarcador">anadirMarcador</a></li><li><a href="global.html#attach">attach</a></li><li><a href="global.html#baja">baja</a></li><li><a href="global.html#calculoOrigen">calculoOrigen</a></li><li><a href="global.html#calibracion">calibracion</a></li><li><a href="global.html#callbackMemorama">callbackMemorama</a></li><li><a href="global.html#cambiarThreshold">cambiarThreshold</a></li><li><a href="global.html#cambiarVisible">cambiarVisible</a></li><li><a href="global.html#cleanMarkers">cleanMarkers</a></li><li><a href="global.html#comunicar">comunicar</a></li><li><a href="global.html#comunicarParticular">comunicarParticular</a></li><li><a href="global.html#definirCaras">definirCaras</a></li><li><a href="global.html#definirSuperficiePorColor">definirSuperficiePorColor</a></li><li><a href="global.html#definirSuperficiePorImagen">definirSuperficiePorImagen</a></li><li><a href="global.html#detectMarker">detectMarker</a></li><li><a href="global.html#etiqueta">etiqueta</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getCamara">getCamara</a></li><li><a href="global.html#getMarkerNumber">getMarkerNumber</a></li><li><a href="global.html#getTransformMatrix">getTransformMatrix</a></li><li><a href="global.html#inicioCalibracion">inicioCalibracion</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initCamara">initCamara</a></li><li><a href="global.html#isAttached">isAttached</a></li><li><a href="global.html#limpiar">limpiar</a></li><li><a href="global.html#logicaCalibracion">logicaCalibracion</a></li><li><a href="global.html#logicaMemorama">logicaMemorama</a></li><li><a href="global.html#loop">loop</a></li><li><a href="global.html#obtenerMarcador">obtenerMarcador</a></li><li><a href="global.html#position">position</a></li><li><a href="global.html#scale">scale</a></li><li><a href="global.html#setCameraMatrix">setCameraMatrix</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#suscribir">suscribir</a></li><li><a href="global.html#update">update</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Feb 17 2017 10:18:54 GMT-0600 (Hora estándar central (México))
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
